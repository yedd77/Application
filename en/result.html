<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NeuroSort - Detection Result</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            width: 100%;
            text-align: center;
            margin: 0 auto;
        }

        .title {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 30px;
        }

        .image-container {
            position: relative;
            display: inline-block;
            margin: 20px 0;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background: white;
        }

        .result-image {
            max-width: 600px;
            max-height: 500px;
            width: auto;
            height: auto;
            display: block;
        }

        .bounding-box {
            position: absolute;
            border: 3px solid;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(2px);
        }

        .detection-info {
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin: 30px 0;
            max-width: 400px;
            margin-left: auto;
            margin-right: auto;
        }

        .detection-label {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 10px;
            text-transform: capitalize;
        }

        .confidence-score {
            font-size: 1rem;
            color: #666;
            margin-bottom: 15px;
        }

        .recyclable-status {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9rem;
            color: white;
            background: #28a745;
        }

        .next-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.1rem;
            font-weight: bold;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            margin-top: 30px;
        }

        .next-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 60vh;
            color: #e74c3c;
        }

        .error h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .error p {
            font-size: 1.1rem;
            margin-bottom: 30px;
        }

        .error-button {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 12px 30px;
            font-size: 1rem;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .error-button:hover {
            background: #c0392b;
            transform: translateY(-1px);
        }

        @media (max-width: 768px) {
            .result-image {
                max-width: 90vw;
                max-height: 400px;
            }
            
            .title {
                font-size: 1.5rem;
            }
            
            .detection-info {
                margin: 20px 10px;
            }
        }
    </style>
</head>
<body>
    <!-- Error State -->
    <div id="error" class="error" style="display: none;">
        <h2>‚ùå Error</h2>
        <p>No detection data found. Please go back and scan an image.</p>
        <button class="error-button" onclick="goBack()">Go Back</button>
    </div>

    <!-- Result State -->
    <div id="result" class="container" style="display: none;">
        <h1 class="title">üîç Detection Result</h1>
        
        <div class="image-container">
            <img id="resultImage" class="result-image" alt="Detection Result">
            <div id="boundingBox" class="bounding-box"></div>
        </div>

        <div class="detection-info">
            <div id="detectionLabel" class="detection-label"></div>
            <div id="confidenceScore" class="confidence-score"></div>
            <div class="recyclable-status">‚ôªÔ∏è Recyclable</div>
        </div>

        <button class="next-button" onclick="goToNextPage()">
            Next Step ‚û°Ô∏è
        </button>
    </div>

    <script>
        // Detection colors
        const DETECTION_COLORS = {
            'paper': '#3498db',
            'plastic': '#f39c12',
            'metal': '#95a5a6',
            'glass': '#27ae60'
        };

        // Get color for detection type
        function getDetectionColor(name) {
            return DETECTION_COLORS[name.toLowerCase()] || '#9b59b6';
        }

        // Get highest confidence prediction
        function getHighestConfidencePrediction(predictions) {
            if (!predictions || predictions.length === 0) return null;
            return predictions.sort((a, b) => b.confidence - a.confidence)[0];
        }

        // Main function to load and display results
        function loadResults() {
            try {
                const imageData = sessionStorage.getItem("uploadedImage");
                const predictionData = localStorage.getItem("prediction");

                if (!imageData || !predictionData) {
                    showError();
                    return;
                }

                const predictions = JSON.parse(predictionData);
                const bestPrediction = getHighestConfidencePrediction(predictions);

                if (!bestPrediction) {
                    showError();
                    return;
                }

                setupResult(imageData, bestPrediction);

            } catch (error) {
                console.error("Error loading results:", error);
                showError();
            }
        }

        // Setup the result display
        function setupResult(imageData, prediction) {
            const resultImage = document.getElementById('resultImage');
            const detectionLabel = document.getElementById('detectionLabel');
            const confidenceScore = document.getElementById('confidenceScore');

            // Set up image
            resultImage.onload = function() {
                document.getElementById('result').style.display = 'block';
                drawBoundingBox(resultImage, prediction);
            };

            resultImage.onerror = function() {
                console.error("Failed to load image");
                showError();
            };

            resultImage.src = imageData;

            // Set up labels
            detectionLabel.textContent = prediction.name;
            detectionLabel.style.color = getDetectionColor(prediction.name);
            
            const confidence = Math.round(prediction.confidence * 100);
            confidenceScore.textContent = `Confidence: ${confidence}%`;
        }

        // Draw bounding box on the image
        function drawBoundingBox(imageElement, prediction) {
            const boundingBox = document.getElementById('boundingBox');
            
            if (!prediction.box) {
                console.log("No bounding box data");
                return;
            }

            const box = prediction.box;
            const naturalWidth = imageElement.naturalWidth;
            const naturalHeight = imageElement.naturalHeight;
            const displayWidth = imageElement.offsetWidth;
            const displayHeight = imageElement.offsetHeight;

            // Calculate scale factors
            const scaleX = displayWidth / naturalWidth;
            const scaleY = displayHeight / naturalHeight;

            // Clamp coordinates to image boundaries
            const clampedBox = {
                x1: Math.max(0, Math.min(box.x1, naturalWidth)),
                y1: Math.max(0, Math.min(box.y1, naturalHeight)),
                x2: Math.max(0, Math.min(box.x2, naturalWidth)),
                y2: Math.max(0, Math.min(box.y2, naturalHeight))
            };

            // Calculate display coordinates
            const displayX1 = clampedBox.x1 * scaleX;
            const displayY1 = clampedBox.y1 * scaleY;
            const displayX2 = clampedBox.x2 * scaleX;
            const displayY2 = clampedBox.y2 * scaleY;

            const boxWidth = displayX2 - displayX1;
            const boxHeight = displayY2 - displayY1;

            // Validate dimensions
            if (boxWidth <= 0 || boxHeight <= 0) {
                console.warn("Invalid box dimensions");
                return;
            }

            // Get color and apply styling
            const color = getDetectionColor(prediction.name);
            boundingBox.style.left = displayX1 + 'px';
            boundingBox.style.top = displayY1 + 'px';
            boundingBox.style.width = boxWidth + 'px';
            boundingBox.style.height = boxHeight + 'px';
            boundingBox.style.borderColor = color;
            boundingBox.style.boxShadow = `0 0 20px ${color}66`;

            console.log("Bounding box positioned successfully", {
                original: box,
                clamped: clampedBox,
                display: { x1: displayX1, y1: displayY1, width: boxWidth, height: boxHeight }
            });
        }

        // Show error state
        function showError() {
            document.getElementById('error').style.display = 'flex';
            document.getElementById('result').style.display = 'none';
        }

        // Navigation functions
        function goBack() {
            window.history.back();
        }

        function goToNextPage() {
            const predictionData = localStorage.getItem("prediction");
            if (!predictionData) return;

            const predictions = JSON.parse(predictionData);
            const bestPrediction = getHighestConfidencePrediction(predictions);
            
            if (!bestPrediction) return;

            const name = bestPrediction.name.toLowerCase();
            
            if (name === "glass" || name === "metal") {
                window.location.href = `trash-guide.html?type=metalOrGlass`;
            } else {
                window.location.href = `trash-guide.html?type=${name}`;
            }
        }

        // Handle window resize
        let resizeTimeout;
        window.addEventListener('resize', () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                const resultImage = document.getElementById('resultImage');
                const predictionData = localStorage.getItem("prediction");
                
                if (resultImage && predictionData && resultImage.complete) {
                    const predictions = JSON.parse(predictionData);
                    const bestPrediction = getHighestConfidencePrediction(predictions);
                    if (bestPrediction) {
                        drawBoundingBox(resultImage, bestPrediction);
                    }
                }
            }, 250);
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', loadResults);
    </script>
</body>
</html>